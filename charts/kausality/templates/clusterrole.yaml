# ClusterRole for the webhook (reads Kausality policies for mode resolution)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kausality.webhookFullname" . }}
  labels:
    {{- include "kausality.webhookLabels" . | nindent 4 }}
rules:
  # Read Kausality policies for mode resolution
  - apiGroups: ["kausality.io"]
    resources: ["kausalities"]
    verbs: ["get", "list", "watch"]

  # Read namespaces for label-based filtering
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch"]
---
# ClusterRole for the controller (manages CRDs, webhook config, RBAC)
{{- if .Values.controller.enabled }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kausality.controllerFullname" . }}
  labels:
    {{- include "kausality.controllerLabels" . | nindent 4 }}
rules:
  # Manage Kausality CRDs
  - apiGroups: ["kausality.io"]
    resources: ["kausalities"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: ["kausality.io"]
    resources: ["kausalities/status"]
    verbs: ["get", "update", "patch"]

  # Manage webhook configuration
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations"]
    verbs: ["get", "list", "watch", "update", "patch"]

  # Manage per-policy ClusterRoles (RBAC generation)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["clusterroles"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Read namespaces for label-based filtering
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "watch"]

  # Broad permissions to delegate via per-policy ClusterRoles.
  # The controller can only grant permissions it holds itself.
  # Note: The controller already manages MutatingWebhookConfiguration which is
  # effectively privileged (can intercept any request). Granting RBAC delegation
  # does not open an additional security hole.
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["get", "list", "watch", "update", "patch"]
{{- end }}
